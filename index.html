<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Cartes disponibles</title>
<style>
  body { font-family: Arial,sans-serif; background:#f4f6f8; margin:0; color:#333; }
  header { background:#fff; padding:20px; font-size:1.6em; font-weight:bold; border-bottom:1px solid #ddd; text-align:center; }
  #counter { text-align:center; font-weight:bold; margin:10px 0; font-size:1.2em; }
  table { width:100%; border-collapse:collapse; background:#fff; }
  thead { background:#fafafa; }
  th, td { padding:10px; font-size:0.9em; border-bottom:1px solid #ddd; text-align:left; vertical-align:middle; }
  tbody tr:hover { background:#f9f9f9; }
  button.demander { background:#28a745; color:#fff; border:none; padding:6px 14px; cursor:pointer; font-weight:bold; border-radius:4px; font-size:0.85em; }
  button.demander:hover { background:#218838; }
  #pseudoForm { margin: 10px auto; max-width: 320px; text-align:center; }
  #pseudoInput { padding: 6px; width: 70%; font-size: 1em; }
  #submitPseudo { padding: 6px 14px; font-size: 1em; margin-left: 8px; cursor: pointer; }
  #message { text-align:center; margin-top:10px; font-weight:bold; }
</style>
</head>
<body>

<header>Cartes disponibles</header>

<div id="counter">Chargement des cartes...</div>

<table>
  <thead>
    <tr>
      <th>BIN</th>
      <th>Banque</th>
      <th>Niveau</th>
      <th>Prix</th>
      <th></th>
    </tr>
  </thead>
  <tbody id="cardsTable"></tbody>
</table>

<!-- Formulaire pseudo Telegram, cachÃ© par dÃ©faut -->
<div id="pseudoForm" style="display:none;">
  <input id="pseudoInput" type="text" placeholder="Votre pseudo Telegram (ex: @pseudo)" />
  <button id="submitPseudo">Confirmer</button>
</div>

<div id="message"></div>

<script>
let cards = [];
let selectedCard = null;

function fetchCards() {
  fetch('cards.txt')
    .then(res => res.text())
    .then(text => {
      cards = parseCards(text);
      renderCards();
    })
    .catch(e => {
      document.getElementById('counter').innerText = "Erreur chargement des cartes";
      console.error(e);
    });
}

function parseCards(text) {
  // Split par ðŸ’³ + 1 NEW CARD
  const rawCards = text.split(/ðŸ’³ \+ 1 NEW CARD/).slice(1);
  return rawCards.map(raw => {
    const card = {};

    // Sauvegarder le raw complet (avec prÃ©fixe ðŸ’³ + 1 NEW CARD)
    card.raw = "ðŸ’³ + 1 NEW CARD" + raw;

    // BIN (dans Extra > Bin : #xxxxxx)
    const binMatch = raw.match(/Bin\s*:\s*#(\d+)/i);
    card.bin = binMatch ? binMatch[1] : "";

    // Banque (CoordonnÃ©es Bancaires > Nom de la banque)
    const banqueMatch = raw.match(/Nom de la banque\s*:\s*(.+)/i);
    card.banque = banqueMatch ? banqueMatch[1].trim() : "";

    // Niveau
    const niveauMatch = raw.match(/Niveau\s*:\s*(.+)/i);
    card.niveau = niveauMatch ? niveauMatch[1].trim() : "";

    // Prix suivant niveau
    const niveauUpper = card.niveau.toUpperCase();
    if (niveauUpper.includes("CLASSIC")) card.prix = "50â‚¬";
    else if (niveauUpper.includes("GOLD")) card.prix = "70â‚¬";
    else if (niveauUpper.includes("BUSINESS")) card.prix = "100â‚¬";
    else if (niveauUpper.includes("INFINITE")) card.prix = "150â‚¬";
    else card.prix = "-";

    return card;
  });
}

function renderCards() {
  const table = document.getElementById('cardsTable');
  table.innerHTML = '';

  if(cards.length === 0){
    document.getElementById('counter').innerText = "Aucune carte disponible.";
    return;
  }

  // Compteurs par niveau
  const counts = { CLASSIC: 0, GOLD: 0, BUSINESS: 0, INFINITE: 0 };

  cards.forEach(card => {
    const niveau = card.niveau.toUpperCase();
    if (counts[niveau] !== undefined) counts[niveau]++;
  });

  const total = cards.length;
  document.getElementById('counter').innerText = 
    `Total: ${total} | Classic: ${counts.CLASSIC} | Gold: ${counts.GOLD} | Business: ${counts.BUSINESS} | Infinite: ${counts.INFINITE}`;

  cards.forEach(card => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${card.bin}</td>
      <td>${card.banque}</td>
      <td>${card.niveau}</td>
      <td>${card.prix}</td>
      <td><button class="demander">Demander</button></td>
    `;
    tr.querySelector('button.demander').addEventListener('click', () => {
      selectedCard = card;
      document.getElementById('pseudoInput').value = '';
      document.getElementById('message').innerText = '';
      document.getElementById('pseudoForm').style.display = 'block';
      document.getElementById('pseudoInput').focus();
      window.scrollTo(0, document.body.scrollHeight);
    });
    table.appendChild(tr);
  });
}

// Envoyer la demande au serveur
document.getElementById('submitPseudo').addEventListener('click', () => {
  const pseudo = document.getElementById('pseudoInput').value.trim();
  if (!pseudo) {
    alert("Merci d'entrer votre pseudo Telegram (ex: @pseudo)");
    return;
  }
  if (!selectedCard) return;

  document.getElementById('submitPseudo').disabled = true;
  document.getElementById('message').innerText = "Envoi en cours...";

  fetch('delete_card.php', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ bin: selectedCard.bin, pseudo: pseudo, raw: selectedCard.raw })
  })
  .then(res => res.json())
  .then(data => {
    if(data.success){
      document.getElementById('message').innerText = "Demande envoyÃ©e avec succÃ¨s !";
      // Supprimer la carte cÃ´tÃ© client pour mise Ã  jour
      cards = cards.filter(c => c.bin !== selectedCard.bin);
      renderCards();
      document.getElementById('pseudoForm').style.display = 'none';
    } else {
      document.getElementById('message').innerText = "Erreur : " + (data.error || 'serveur');
    }
  })
  .catch(e => {
    document.getElementById('message').innerText = "Erreur rÃ©seau";
    console.error(e);
  })
  .finally(() => {
    document.getElementById('submitPseudo').disabled = false;
  });
});

fetchCards();
</script>

</body>
</html>
